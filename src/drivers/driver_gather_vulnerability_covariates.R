# Script Name: driver_gather_vulnerability_covariates
# Purpose: Append static covariate values to line-list data
# Author: Michael Mcphail
# Date: 2024-07-05
# Dependencies: raster, Matrix, dplyr, tidyr, rgdal, sp, terra, sf, optparse 
# Usage: Rscript my_script.R input_file.csv output_file.csv

library(raster)
# library(Matrix)
library(dplyr)
# library(tidyr)
library(rgdal)
library(sp)
library(terra)
library(sf)
library(optparse)
library(jsonlite)

#The following code takes a structured data base, builds a covariate data base for each admin unit, for each month, 
#for each year. Then it attatches the selected (static) covariates 

# input data should at least have the following columns c('LONG', 'LAT', 'imported', 'mp_species', 'month_int', 'year', 'is_index_case')
# If the input data is taken from the output of the network diffusion model, then these columns will be present.

#In this script we append covariates for observed locations, as well as for the rest of the specified country, 
# in order to streamline prediction.

load_config <- function(config_path) {
  config <- fromJSON(config_path)
  return(config)
}

option_list <- list(
  make_option(c("--config"), type="character", default=NULL, 
              help="Path to the configuration file", metavar="character")
)

opt_parser <- OptionParser(option_list=option_list)
opt <- parse_args(opt_parser)

if (is.null(opt$config)) {
  print_help(opt_parser)
  stop("The --config argument is required", call.=FALSE)
}


#---------------------------------------------------------------------------------------------------------------#
#             Start: Configuration
#---------------------------------------------------------------------------------------------------------------#
config <- load_config(opt$config)

# Data base to load (i.e. input data)
case_data_withRe_fn <- config$case_data_withRe_fn

#File name to save values with covariates to. 
case_data_withVulnCovs_fn <- config$case_data_withVulnCovs_fn
if(!dir.exists(dirname(case_data_withVulnCovs_fn))){
  dir.create(dirname(case_data_withVulnCovs_fn))
}

#country of interest iso3 code
country_iso = config$country_iso
# extent_vec <- c(101,110 ,7, 24) #(LONGMIN, LONGMAX, LATMIN, LATMAX)
extent_vec <- config$country_extent #(LONGMIN, LONGMAX, LATMIN, LATMAX)


#Load file path information
source('./configuration_data/data_lookup.R')

limited_df <- read.csv(case_data_withRe_fn)
#Covariates that never change
#Add bioclim variables
static_cov_name_list = c('ELEVATION', 'ACCESSIBILITY', 'POPULATION','VIIRS', 'URBAN', 'BUILDINGS', 'FOREST') #Easier to add forrest factor in the driver script # treat population as static (use 2020)

#------------------------------------------------------------------------------------------#
#       Step 0: Get background points for eventual prediction
#------------------------------------------------------------------------------------------#
# Note that for the background points, we set 'is_index_case'=0. In reality there will be overlap between
# the background points and the observed index cases. The output data, however, has only index cases and background points
# so effectively 'is_index_case' partitions training data from prediction. 

# Create extent object from config
country_subset_extent <- extent(extent_vec)

# Read and filter shapefile for country
full_sf <- st_read(paste0(shape_file_paths$prefix, '0', shape_file_paths$suffix)) 
sub_sf <- full_sf[full_sf$ISO %in% country_iso,]  # Removed unnecessary c()

# Create masked raster for country
cropped_raster <- raster(static_fn_str_list[static_cov_name_list[1]]) %>% 
  crop(country_subset_extent)
buffer.image <- cropped_raster %>% 
  mask(st_zm(sub_sf))  # Simplified chaining

# Extract valid coordinates
buffer.values <- getValues(buffer.image)
valid.pix <- which(!is.na(buffer.values) & buffer.values >= 0)
valid.coords <- coordinates(buffer.image)[valid.pix,]

# Create background points dataframe
valid_coord_df <- data.frame(
  LONG = valid.coords[,1],
  LAT = valid.coords[,2],
  imported = 'N',
  is_index_case = 0,
  mp_species = 'NONE',
  month_int = 0,
  year = 2000
)

# Combine background points with index cases
index_cols <- c('LONG', 'LAT', 'imported', 'mp_species', 'month_int', 'year', 'is_index_case')
limited_df <- rbind(
  valid_coord_df,
  limited_df[limited_df$is_index_case == '1', index_cols]
)
limited_df$admin_level <- 'POINT'
#------------------------------------------------------------------------------------------#
#       Step 1: build point data frame
#------------------------------------------------------------------------------------------#
limited_df <- limited_df[!is.na(limited_df$LAT)&(!is.na(limited_df$LONG)),]

for (cov_name in static_cov_name_list){
    message(paste('Extracting static covariate', cov_name))
    limited_df[cov_name] <-NA
    cov_fn <- static_fn_str_list[cov_name]
    cov_rast <- terra::rast(cov_fn)
    covariate_sub_values <- terra::extract(cov_rast, limited_df[,c('LONG', 'LAT')])
    limited_df[,cov_name]<- covariate_sub_values[,2]
}


write.csv(limited_df, case_data_withVulnCovs_fn, row.names=FALSE)
